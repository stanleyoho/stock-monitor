// ËÇ°Á•®Áõ£ÊéßÊáâÁî®JavaScript

class StockMonitor {
    constructor() {
        this.charts = {};
        this.updateInterval = null;
        this.advancedView = false;
        this.portfolioData = null;
        this.init();
    }

    async init() {
        console.log('ÂàùÂßãÂåñËÇ°Á•®Áõ£ÊéßÊáâÁî®');
        await this.loadSignals();
        await this.loadPortfolio();
        await this.loadCharts();
        this.startAutoUpdate();
    }

    async loadSignals() {
        try {
            const response = await fetch('/api/signals');
            const data = await response.json();
            
            if (data.success) {
                this.renderEnhancedSignals(data.data);
                this.updateMarketOverview(data.vix_level, data.market_sentiment);
                this.updateRebalanceAlert(data.portfolio_suggestions);
                this.updateLastUpdateTime(data.timestamp);
            } else {
                console.error('ËºâÂÖ•‰ø°ËôüÂ§±Êïó:', data.error);
                this.showError('ËºâÂÖ•‰∫§Êòì‰ø°ËôüÂ§±Êïó');
            }
        } catch (error) {
            console.error('APIË´ãÊ±ÇÂ§±Êïó:', error);
            this.showError('Á∂≤Ë∑ØÈÄ£Êé•Â§±ÊïóÔºåË´ãÊ™¢Êü•ÈÄ£Êé•');
        }
    }

    renderEnhancedSignals(signals) {
        const container = document.getElementById('signalsContainer');
        
        if (!signals || signals.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Êö´ÁÑ°‰∫§Êòì‰ø°Ëôü</div>';
            return;
        }

        let html = '<div class="row">';
        
        signals.forEach(signal => {
            const signalClass = signal.signal.toLowerCase();
            const signalIcon = this.getSignalIcon(signal.signal);
            const confidencePercent = (signal.confidence * 100).toFixed(0);
            
            html += `
                <div class="col-lg-6 mb-3">
                    <div class="enhanced-signal signal-${signalClass}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h6 class="mb-0">${signal.symbol}</h6>
                                <span class="strategy-tag strategy-${signal.strategy}">${signal.strategy}</span>
                            </div>
                            <span class="signal-badge">${signalIcon} ${signal.signal}</span>
                        </div>
                        
                        <div class="stock-price">$${signal.current_price ? signal.current_price.toFixed(2) : 'N/A'}</div>
                        
                        <div class="row mt-2">
                            <div class="col-4">
                                <div class="indicator">
                                    <div class="indicator-label">SMA20</div>
                                    <div class="indicator-value">${signal.sma_20 ? '$' + signal.sma_20.toFixed(2) : 'N/A'}</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="indicator">
                                    <div class="indicator-label">RSI</div>
                                    <div class="indicator-value">${signal.rsi ? signal.rsi.toFixed(1) : 'N/A'}</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="indicator">
                                    <div class="indicator-label">‰ø°ÂøÉÂ∫¶</div>
                                    <div class="indicator-value">${confidencePercent}%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                        </div>
                        
                        <div class="mt-2">
                            ${signal.reasons && signal.reasons.length > 0 ? 
                                signal.reasons.map(reason => `<small class="text-muted d-block">‚Ä¢ ${reason}</small>`).join('') 
                                : '<small class="text-muted">ÁÑ°ÁâπÊÆäË®äËôü</small>'}
                        </div>
                        
                        <div class="advanced-info">
                            <div class="row mt-2">
                                ${signal.stop_loss_price ? `
                                    <div class="col-6">
                                        <div class="indicator">
                                            <div class="indicator-label">ÂÅúÊêçÂÉπ</div>
                                            <div class="indicator-value text-danger">$${signal.stop_loss_price.toFixed(2)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${signal.target_price ? `
                                    <div class="col-6">
                                        <div class="indicator">
                                            <div class="indicator-label">ÁõÆÊ®ôÂÉπ</div>
                                            <div class="indicator-value text-success">$${signal.target_price.toFixed(2)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            ${signal.macd ? `
                                <div class="row mt-1">
                                    <div class="col-6">
                                        <div class="indicator">
                                            <div class="indicator-label">MACD</div>
                                            <div class="indicator-value">${signal.macd.toFixed(3)}</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="indicator">
                                            <div class="indicator-label">SMA50</div>
                                            <div class="indicator-value">${signal.sma_50 ? '$' + signal.sma_50.toFixed(2) : 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    async loadPortfolio() {
        try {
            const response = await fetch('/api/portfolio');
            const data = await response.json();
            
            if (data.success) {
                this.portfolioData = data;
                this.updatePortfolioOverview(data.analysis, data.expected_returns);
                this.renderReturnProjections(data.expected_returns);
            }
        } catch (error) {
            console.error('ËºâÂÖ•ÊäïË≥áÁµÑÂêàÂ§±Êïó:', error);
        }
    }

    updateMarketOverview(vixLevel, marketSentiment) {
        const vixElement = document.getElementById('vixLevel');
        const sentimentElement = document.getElementById('marketSentiment');
        
        if (vixElement && vixLevel) {
            vixElement.textContent = vixLevel.toFixed(1);
            vixElement.className = 'indicator-value';
            
            if (vixLevel > 30) {
                vixElement.classList.add('sentiment-panic');
            } else if (vixLevel > 20) {
                vixElement.classList.add('sentiment-fear');
            } else if (vixLevel > 15) {
                vixElement.classList.add('sentiment-neutral');
            } else {
                vixElement.classList.add('sentiment-greed');
            }
        }
        
        if (sentimentElement && marketSentiment) {
            const sentimentMap = {
                'panic': 'üò® ÊÅêÊÖå',
                'fear': 'üò∞ ÊÅêÊáº',
                'neutral': 'üòê ‰∏≠ÊÄß',
                'greed': 'ü§ë Ë≤™Â©™'
            };
            sentimentElement.textContent = sentimentMap[marketSentiment] || marketSentiment;
            sentimentElement.className = `indicator-value sentiment-${marketSentiment}`;
        }
    }

    updatePortfolioOverview(analysis, expectedReturns) {
        const portfolioValueElement = document.getElementById('portfolioValue');
        const expectedReturnElement = document.getElementById('expectedReturn');
        
        if (portfolioValueElement && analysis && analysis.total_value) {
            const totalValue = analysis.total_value.total;
            portfolioValueElement.textContent = this.formatCurrency(totalValue);
        }
        
        if (expectedReturnElement && expectedReturns) {
            const annualReturn = expectedReturns.expected_annual_return * 100;
            expectedReturnElement.textContent = `${annualReturn.toFixed(1)}%`;
            expectedReturnElement.className = annualReturn > 0 ? 'indicator-value sentiment-greed' : 'indicator-value sentiment-fear';
        }
    }

    updateRebalanceAlert(suggestions) {
        const alertElement = document.getElementById('rebalanceAlert');
        const contentElement = document.getElementById('rebalanceContent');
        
        if (!suggestions || suggestions.length === 0) {
            alertElement.style.display = 'none';
            return;
        }
        
        let html = '<p><strong>Âª∫Ë≠∞ÈÄ≤Ë°å‰ª•‰∏ãË™øÊï¥:</strong></p>';
        suggestions.forEach(suggestion => {
            const actionClass = suggestion.action.toLowerCase() === 'buy' ? 'rebalance-buy' : 'rebalance-sell';
            const actionText = suggestion.action === 'BUY' ? 'Ë≤∑ÂÖ•' : 'Ë≥£Âá∫';
            
            html += `
                <div class="rebalance-suggestion">
                    <span class="rebalance-action ${actionClass}">${actionText}</span>
                    <strong>${suggestion.symbol}</strong> 
                    ${this.formatCurrency(suggestion.amount)}
                    <br><small>${suggestion.reason}</small>
                </div>
            `;
        });
        
        contentElement.innerHTML = html;
        alertElement.style.display = 'block';
    }

    renderReturnProjections(expectedReturns) {
        const container = document.getElementById('returnProjections');
        
        if (!expectedReturns) {
            container.innerHTML = '<div class="alert alert-warning">ÁÑ°Ê≥ïË®àÁÆóÈ†êÊúüÂ†±ÈÖ¨</div>';
            return;
        }
        
        const projections = [
            { time: '1Âπ¥Âæå', value: expectedReturns.projected_value_1y, current: expectedReturns.current_value },
            { time: '3Âπ¥Âæå', value: expectedReturns.projected_value_3y, current: expectedReturns.current_value },
            { time: '5Âπ¥Âæå', value: expectedReturns.projected_value_5y, current: expectedReturns.current_value }
        ];
        
        let html = '<div class="row">';
        
        projections.forEach(proj => {
            const gain = proj.value - proj.current;
            const returnPercent = ((proj.value - proj.current) / proj.current * 100).toFixed(1);
            
            html += `
                <div class="col-md-4">
                    <div class="return-projection">
                        <div class="return-time">${proj.time}</div>
                        <div class="return-value">+${returnPercent}%</div>
                        <div class="return-amount">
                            ${this.formatCurrency(proj.value)}<br>
                            <small class="text-success">+${this.formatCurrency(gain)}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // È¢®Èö™ÂçÄÈñì
        html += `
            <div class="col-12 mt-3">
                <div class="alert alert-info">
                    <strong>üìä 1Âπ¥ÂæåÂèØËÉΩÂçÄÈñì:</strong><br>
                    Ê®ÇËßÄÊÉÖÂ¢É: <span class="text-success">${this.formatCurrency(expectedReturns.best_case_1y)}</span> | 
                    ÊÇ≤ËßÄÊÉÖÂ¢É: <span class="text-danger">${this.formatCurrency(expectedReturns.worst_case_1y)}</span><br>
                    <small>* È†êÊúüÂ†±ÈÖ¨Âü∫ÊñºÊ≠∑Âè≤Êï∏ÊìöÔºåÂØ¶ÈöõÁµêÊûúÂèØËÉΩÊúâÊâÄ‰∏çÂêå</small>
                </div>
            </div>
        `;
        
        html += '</div>';
        container.innerHTML = html;
    }

    formatCurrency(amount) {
        if (amount >= 1000000) {
            return `$${(amount / 1000000).toFixed(1)}M`;
        } else if (amount >= 1000) {
            return `$${(amount / 1000).toFixed(0)}K`;
        } else {
            return `$${amount.toFixed(0)}`;
        }
    }

    getSignalIcon(signal) {
        switch (signal) {
            case 'BUY': return 'üü¢';
            case 'SELL': return 'üî¥';
            case 'HOLD': return 'üü°';
            default: return '‚ö™';
        }
    }

    async loadCharts() {
        const stocks = ['QQQ', 'NVDA', 'VOO'];
        
        for (const stock of stocks) {
            try {
                const response = await fetch(`/api/stock/${stock}`);
                const data = await response.json();
                
                if (data.success) {
                    this.createChart(stock, data.chart_data, data.signal);
                    this.updateStockDetail(stock, data.signal);
                } else {
                    console.error(`ËºâÂÖ•${stock}ÂúñË°®Â§±Êïó:`, data.error);
                }
            } catch (error) {
                console.error(`ËºâÂÖ•${stock}ÂúñË°®ÊôÇÁôºÁîüÈåØË™§:`, error);
            }
        }
    }

    createChart(symbol, chartData, signal) {
        const ctx = document.getElementById(`chart${symbol}`);
        if (!ctx) {
            console.error(`Êâæ‰∏çÂà∞ÂúñË°®ÂÖÉÁ¥†: chart${symbol}`);
            return;
        }

        // Â¶ÇÊûúÂúñË°®Â∑≤Â≠òÂú®ÔºåÂÖàÈä∑ÊØÄ
        if (this.charts[symbol]) {
            this.charts[symbol].destroy();
        }

        const dates = chartData.dates.slice(-30); // Âè™È°ØÁ§∫ÊúÄËøë30Â§©
        const prices = chartData.prices.slice(-30);
        const sma20 = chartData.sma_20.slice(-30);

        this.charts[symbol] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'ËÇ°ÂÉπ',
                        data: prices,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'SMA20',
                        data: sma20,
                        borderColor: '#fd7e14',
                        backgroundColor: 'rgba(253, 126, 20, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: `${symbol} - ÂÉπÊ†ºË∂®Âã¢`
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Êó•Êúü'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'ÂÉπÊ†º ($)'
                        }
                    }
                }
            }
        });
    }

    updateStockDetail(symbol, signal) {
        const detailElement = document.getElementById(`detail${symbol}`);
        if (!detailElement || !signal) return;

        const signalClass = signal.signal.toLowerCase();
        const signalIcon = this.getSignalIcon(signal.signal);

        detailElement.innerHTML = `
            <div class="indicator mb-2">
                <span class="indicator-label">Áï∂Ââç‰ø°Ëôü:</span>
                <span class="indicator-value signal-badge signal-${signalClass}">${signalIcon} ${signal.signal}</span>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="indicator">
                        <div class="indicator-label">ÂÉπÊ†º</div>
                        <div class="indicator-value">$${signal.current_price.toFixed(2)}</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="indicator">
                        <div class="indicator-label">RSI</div>
                        <div class="indicator-value">${signal.rsi.toFixed(1)}</div>
                    </div>
                </div>
            </div>
        `;
    }

    updateLastUpdateTime(timestamp) {
        const updateElement = document.getElementById('lastUpdate');
        if (updateElement) {
            const date = new Date(timestamp);
            updateElement.textContent = date.toLocaleString('zh-TW');
        }
    }

    startAutoUpdate() {
        // ÊØè5ÂàÜÈêòËá™ÂãïÊõ¥Êñ∞‰∏ÄÊ¨°
        this.updateInterval = setInterval(async () => {
            console.log('Ëá™ÂãïÊõ¥Êñ∞Êï∏Êìö...');
            await this.loadSignals();
            // ÂúñË°®‰∏çÈúÄË¶ÅÈ†ªÁπÅÊõ¥Êñ∞ÔºåÂè™Êõ¥Êñ∞‰ø°Ëôü
        }, 5 * 60 * 1000);
    }

    stopAutoUpdate() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }

    showError(message) {
        const container = document.getElementById('signalsContainer');
        container.innerHTML = `
            <div class="alert alert-danger">
                <strong>ÈåØË™§:</strong> ${message}
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="stockMonitor.loadSignals()">
                    ÈáçÊñ∞ËºâÂÖ•
                </button>
            </div>
        `;
    }

    toggleAdvancedView() {
        this.advancedView = !this.advancedView;
        const signalsContainer = document.getElementById('signalsContainer');
        const toggleText = document.getElementById('advancedToggleText');
        
        if (this.advancedView) {
            signalsContainer.classList.add('show-advanced');
            toggleText.textContent = 'Èö±ËóèË©≥Á¥∞';
        } else {
            signalsContainer.classList.remove('show-advanced');
            toggleText.textContent = 'È°ØÁ§∫Ë©≥Á¥∞';
        }
    }

    toggleStrategyInfo() {
        const panel = document.getElementById('strategyInfoPanel');
        const toggleText = document.getElementById('strategyToggleText');
        
        if (panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'block';
            toggleText.textContent = 'Èö±ËóèË™™Êòé';
        } else {
            panel.style.display = 'none';
            toggleText.textContent = 'Á≠ñÁï•Ë™™Êòé';
        }
    }

    // ÊâãÂãïÈáçÊñ∞Êï¥ÁêÜ
    async refresh() {
        console.log('ÊâãÂãïÈáçÊñ∞Êï¥ÁêÜ...');
        const container = document.getElementById('signalsContainer');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">ËºâÂÖ•‰∏≠...</span>
                </div>
                <p class="mt-2">Ê≠£Âú®Êõ¥Êñ∞Êï∏Êìö...</p>
            </div>
        `;
        
        await this.loadSignals();
        await this.loadPortfolio();
        await this.loadCharts();
    }
}

// ÂàùÂßãÂåñÊáâÁî®
let stockMonitor;

document.addEventListener('DOMContentLoaded', function() {
    stockMonitor = new StockMonitor();
    
    // Ê∑ªÂä†Âø´Êç∑ÈçµÊîØÊåÅ
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            stockMonitor.refresh();
        }
    });
});

// È†ÅÈù¢Âç∏ËºâÊôÇÂÅúÊ≠¢Ëá™ÂãïÊõ¥Êñ∞
window.addEventListener('beforeunload', function() {
    if (stockMonitor) {
        stockMonitor.stopAutoUpdate();
    }
});

// ÂÖ®Â±ÄÂáΩÊï∏
function refreshData() {
    if (stockMonitor) {
        stockMonitor.refresh();
    }
}

function toggleAdvancedView() {
    if (stockMonitor) {
        stockMonitor.toggleAdvancedView();
    }
}

function toggleStrategyInfo() {
    if (stockMonitor) {
        stockMonitor.toggleStrategyInfo();
    }
}